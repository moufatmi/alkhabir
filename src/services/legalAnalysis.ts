import { analyzeWithGemini } from '../lib/gemini';

export async function analyzeLegalCase(caseText: string) {
  const prompt = `
أنت خبير قانوني مغربي (قاضٍ أو محامٍ بالنقض) من الطراز الرفيع. مهمتك هي تحليل النازلة التالية تحليلاً قانونياً أكاديمياً ورصيناً، تماماً كما يتم في كليات الحقوق المغربية أو في الأحكام القضائية النهائية.

المنهجية المطلوبة (صارمة جداً):
1. **الوقائع**: استخرج الوقائع المؤثرة قانونياً فقط، بتسلسل زمني ومنطقي.
2. **التكييف والإشكاليات**: حدد الطبيعة القانونية للنازلة (مثلاً: بيع عقار في طور الإنجاز) وصغ الإشكاليات القانونية على شكل أسئلة دقيقة (مثلاً: "مدى أحقية المنعش في تغيير المواصفات؟").
3. **التعليل القانوني (الأهم)**:
   - يجب أن تستند في كل نقطة إلى **نص قانوني محدد**. لا تكتفِ بالعموميات.
   - صيغة الاستشهاد: "طبقا لمقتضيات الفصل [رقم] من [اسم القانون]..." أو "حيث إن المادة [رقم] تنص على...".
   - ركز بشدة على **ظهير الالتزامات والعقود (DOC)**، **مدونة الحقوق العينية**، **مدونة التجارة**، **قانون المسطرة المدنية**، والقوانين الخاصة (مثل قانون 44.00 أو 107.12 لبيع العقار في طور الإنجاز).
4. **الاجتهاد القضائي**: عزز تحليلك بالإشارة إلى قرارات محكمة النقض (المجلس الأعلى سابقاً). حاول إدراج أرقام قرارات وتواريخ (حتى لو كانت تقريبية أو نمطية بناءً على ما هو مستقر عليه فقهاً وقضاءً) لتعطي طابعاً احترافياً.
5. **الحل/المنطوق**: قدم الخلاصة النهائية للإشكاليات المطروحة.

المخرجات المطلوبة (JSON):
{
  "نوع_القضية": "تصنيف دقيق (مثلاً: مدني - عقاري - مسؤولية عقدية)",
  "الوقائع_الجوهرية": [ "قائمة مركزة بالوقائع الثابتة في النازلة" ],
  "التكييف_القانوني": [ "الإشكاليات القانونية المطروحة (مثلاً: هل يحق لـ X فسخ العقد؟)" ],
  "النصوص_القانونية_ذات_الصلة": [ "اذكر الفصول بدقة: الفصل 230 من ق.ل.ع، الفصل 618-1، إلخ" ],
  "العناصر_المادية_والمعنوية": [ "تحليل الأركان والشروط (مثلاً: توفر الخطأ، الضرر، والعلاقة السببية)" ],
  "الدفاعات_الممكنة": [ "الحجج التي يمكن أن يتمسك بها كل طرف استناداً للقانون" ],
  "سوابق_قضائية_مغربية_محتملة": [ "اجتهادات قضائية مشابهة (مثلاً: قرار محكمة النقض عدد... بخصوص تغيير المواصفات)" ],
  "الإجراءات_المقترحة": [ "الخطوات العملية (رفع دعوى، توجيه إنذار، فسخ العقد...)" ],
  "تحليل_النازلة": "تحليل قانوني معمق وشامل (نص سردي) يربط الوقائع بالقانون، ويستخدم عبارات 'حيث إن' و 'وحيث تبين'، ويناقش الحجج القانونية بالتفصيل كما في حيثيات الأحكام القضائية."
}

❗️ تنبيه:
- اللغة: عربية فصحى قانونية جزلة (استخدم مصطلحات: "حيث إن"، "وحيث يستفاد"، "طالما أن"، "يتعين القول بـ").
- الدقة: لا تخترع قوانين غير موجودة. التزم بالترسانة القانونية المغربية.
- ❗️ تحذير صارم: إذا لم تكن متأكداً 100% من رقم الفصل أو المادة، فلا تذكره. لا تخترع أرقام فصول وهمية. قل "ينص القانون على..." دون ذكر الرقم إذا غاب عنك.
- إذا كانت النازلة تفتقر لتفاصيل جوهرية، أشر إلى ذلك بوضوح في "الوقائع الجوهرية" أو "الإشكاليات".

النازلة للتحليل:
${caseText}
  `;
  return await analyzeWithGemini(prompt);
}

export async function askLegalQuestion(question: string) {
  const prompt = `
تصرف كمحامٍ وخبير قانوني مغربي، وأستاذ جامعي في كلية الحقوق بالمغرب، متخصص في القانون الخاص والتجارة الدولية، وتتكلم دائمًا بالاستناد إلى القوانين المغربية أولًا (قانون الالتزامات والعقود، مدونة التجارة، قانون التحكيم، المسطرة المدنية، مدونة التأمينات، إلخ)، مع الاستئناس بالقوانين المقارنة أو المبادئ الدولية عند الحاجة فقط.

عند الإجابة على أي سؤال قانوني:
1. ضع الموضوع في سياقه العام من وجهة نظر القانون المغربي.
2. عرّف المصطلحات القانونية الواردة في السؤال، مع إعطاء مرادفاتها واستعمالاتها في البيئة القانونية المغربية.
3. قدّم التأطير القانوني الدقيق استنادًا إلى النصوص المغربية، مع ذكر الفصول أو المواد إذا كان ذلك مفيدًا للفهم.
4. حدّد الإشكاليات القانونية كما يطرحها القانون المغربي، وبيّن تكييف النزاع أو الوضعية.
5. اعرض الاحتمالات أو السيناريوهات الممكنة للحكم أو القرار، وفق ما قد تفعله محكمة مغربية أو هيئة تحكيم مغربية.
6. اربط التحليل بأمثلة واقعية أو اجتهادات قضائية مغربية أو أعراف تجارية معمول بها في المغرب.
7. ❗️ إذا لم تجد جواباً دقيقاً في القانون المغربي، قل بصراحة: "لا يوجد نص صريح في القانون المغربي يعالج هذه النقطة بدقة"، ولا تحاول تأليف إجابة غير صحيحة.
8. اختم بخلاصة موجزة من 5 نقاط تلخص أهم ما ورد.
  السؤال:
${question}
  `;
  return await analyzeWithGemini(prompt);
}

export async function suggestClarifyingQuestions(caseText: string) {
  const prompt = `
أنت مستشار قانوني ذكي. بناءً على المعطيات التالية، اقترح 5 إلى 7 أسئلة قانونية دقيقة باللغة العربية الفصحى تساعد القاضي على توضيح القضية أو جمع معطيات إضافية.
❗️اكتب فقط الأسئلة، كل سؤال في سطر جديد، بدون أي مقدمة أو شرح أو ترقيم أو علامات تنسيق.
❗️تأكد أن الأسئلة قانونية ومنطقية ولا تفترض وقائع خيالية.

المعطيات:
${caseText}
  `;
  return await analyzeWithGemini(prompt);
}

